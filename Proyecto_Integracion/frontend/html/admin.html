<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Administrador</title>
  <link rel="stylesheet" href="../css/estilos.css">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  
  <div class="navegacion">
    <div class="marca">
      <img src="../img/hospital_logo.jpg" class="logo-img" alt="Hospital Curicó">
      <span>Panel Administrador</span>
    </div>
    <button class="boton primario" onclick="cerrarSesion()">Cerrar sesión</button>
  </div>
  
  <div class="contenedor">
      <div id="aplicacion-admin"></div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const rol = localStorage.getItem("rol");
    if(!token || rol !== "admin"){
      alert("Acceso no autorizado");
      location.href = "inicio.html";
    }
    function cerrarSesion(){
      localStorage.clear();
      location.href = "inicio.html";
    }
  </script>
  
  <script type="text/babel" src="../js/app.js"></script> 
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const ROLES = [
        { value: 'paciente', label: 'Paciente' },
        { value: 'doctor', label: 'Doctor' },
        { value: 'admin', label: 'Administrador' }
    ];
    
    const formatRol = (rol) => {
      if (rol === 'admin') return 'Administrador';
      if (rol === 'doctor') return 'Doctor';
      return 'Paciente';
    };

    function ModalEditarUsuario({ usuario, onClose, onSave }) {
        const [formData, setFormData] = useState({ 
            ...usuario,
            telefono: usuario.telefono || '' 
        });
        const [cargando, setCargando] = useState(false);
        const [error, setError] = useState(null);

        const handleChange = (e) => {
            setFormData({ ...formData, [e.target.name]: e.target.value });
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            setCargando(true);
            setError(null);
            
            try {
                await api("usuarios.php", {
                    metodo: "PUT",
                    cuerpo: formData,
                    token: localStorage.getItem("token")
                });
                
                alert("Usuario actualizado con éxito.");
                onSave(); 
            } catch (e) {
                setError(e.message);
            } finally {
                setCargando(false);
            }
        };

        return (
            <div className="modal-fondo">
                <div className="tarjeta" style={{maxWidth:600, margin:'20px auto', position:'relative'}}>
                    <button onClick={onClose} className="boton" style={{position:'absolute', top:'10px', right:'10px', background:'none', border:'none', fontSize:'1.5rem', cursor:'pointer'}}>
                        &times;
                    </button>
                    <h2><i className="fa-solid fa-pen-to-square"></i> Editar Usuario (ID: {formData.id_paciente})</h2>
                    <form onSubmit={handleSubmit}>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px', marginTop:'15px'}}>
                            
                            <div>
                                <label className="etiqueta">RUT</label>
                                <input className="campo" type="text" name="rut" value={formData.rut} onChange={handleChange} required/>
                            </div>
                            
                            <div>
                                <label className="etiqueta">Rol</label>
                                <select className="campo" name="rol" value={formData.rol} onChange={handleChange} required>
                                    {ROLES.map(r => (
                                        <option key={r.value} value={r.value}>{r.label}</option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label className="etiqueta">Nombres</label>
                                <input className="campo" type="text" name="nombres" value={formData.nombres} onChange={handleChange} required/>
                            </div>
                            
                            <div>
                                <label className="etiqueta">Apellidos</label>
                                <input className="campo" type="text" name="apellidos" value={formData.apellidos} onChange={handleChange} required/>
                            </div>

                            <div>
                                <label className="etiqueta">Email</label>
                                <input className="campo" type="email" name="email" value={formData.email} onChange={handleChange} required/>
                            </div>
                            
                            <div>
                                <label className="etiqueta">Teléfono</label>
                                <input className="campo" type="tel" name="telefono" value={formData.telefono} onChange={handleChange}/>
                            </div>
                        </div>

                        <div style={{marginTop:20, display:'flex', gap:10}}>
                            <button className="boton primario" type="submit" disabled={cargando}>
                                {cargando ? "Guardando..." : "Guardar Cambios"}
                            </button>
                            <button className="boton" type="button" onClick={onClose} disabled={cargando}>
                                Cancelar
                            </button>
                        </div>

                        {error && <p className="err" style={{marginTop:10}}>Error: {error}</p>}
                    </form>
                </div>
            </div>
        );
    }


    function TablaUsuarios({ usuarios, onUsuarioEliminado, onModificarUsuario }) { 
        
        const eliminarUsuario = async (id, nombre) => {
            if (!confirm(`¿Estás seguro de eliminar a ${nombre} (ID: ${id})? Esta acción es irreversible.`)) {
                return;
            }
            const token = localStorage.getItem("token");
            try {
                await api(`usuarios.php?id=${id}`, { metodo: "DELETE", token });
                alert(`Usuario ${nombre} eliminado exitosamente.`);
                onUsuarioEliminado(); 
            } catch (e) {
                alert(`Error al eliminar: ${e.message}`);
            }
        };

        return (
            <div className="tarjeta" style={{marginTop:20, overflowX: 'auto'}}>
                <h3><i className="fa-solid fa-users"></i> Listado de Usuarios</h3>
                <table style={{width:'100%', borderCollapse:'collapse'}}>
                    <thead>
                        <tr style={{background:'#f2f8f5'}}>
                            <th style={{textAlign:'left', padding:'8px'}}>ID</th>
                            <th style={{textAlign:'left', padding:'8px'}}>RUT</th>
                            <th style={{textAlign:'left', padding:'8px'}}>Nombre Completo</th>
                            <th style={{textAlign:'left', padding:'8px'}}>Email</th>
                            <th style={{textAlign:'center', padding:'8px'}}>Rol</th>
                            <th style={{textAlign:'center', padding:'8px'}}>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {usuarios.length === 0 ? (
                            <tr><td colSpan="6" style={{textAlign:'center', padding:'10px'}}>No hay usuarios registrados.</td></tr>
                        ) : (
                            usuarios.map(u => (
                                <tr key={u.id_paciente} style={{borderBottom: '1px solid #eee'}}>
                                    <td style={{padding:'8px'}}>{u.id_paciente}</td>
                                    <td style={{padding:'8px'}}>{u.rut}</td>
                                    <td style={{padding:'8px'}}>{`${u.nombres} ${u.apellidos}`}</td>
                                    <td style={{padding:'8px'}}>{u.email}</td>
                                    <td style={{padding:'8px', textAlign:'center'}}>
                                        <span style={{fontWeight: 'bold', color: u.rol === 'admin' ? 'var(--acento)' : (u.rol === 'doctor' ? 'var(--ok)' : 'var(--texto)')}}>
                                            {formatRol(u.rol)}
                                        </span>
                                    </td>
                                    <td style={{padding:'8px', textAlign:'center', display:'flex', gap:'5px', justifyContent:'center'}}>
                                        <button className="boton" onClick={() => onModificarUsuario(u)}> 
                                            <i className="fa-solid fa-pen-to-square"></i>
                                        </button>
                                        <button className="boton" 
                                                onClick={() => eliminarUsuario(u.id_paciente, u.nombres)}
                                                style={{background:'#e74c3c', color:'#fff', border:'none'}}>
                                            <i className="fa-solid fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        );
    }

    function FormularioAgregarPaciente({ onPacienteAgregado }){
          const [formData, setFormData] = useState({
              rut: '', nombres: '', apellidos: '', email: '', telefono: '', contrasena: 'demo123'
          });
          const [cargando, setCargando] = useState(false);
          const [error, setError] = useState(null);
          const [exito, setExito] = useState(null);

          const handleChange = (e) => {
              setFormData({...formData, [e.target.name]: e.target.value});
          };

          const handleSubmit = async (e) => {
              e.preventDefault();
              setCargando(true); setError(null); setExito(null);
              
              const token = localStorage.getItem("token");

              try {
                  const res = await api("agregar_paciente.php", {
                      metodo: "POST", 
                      cuerpo: formData,
                      token: token 
                  });
                  
                  setExito(res.detail || "Paciente agregado exitosamente.");
                  setFormData({rut: '', nombres: '', apellidos: '', email: '', telefono: '', contrasena: 'demo123'});
                  onPacienteAgregado(); 
              } catch(e) {
                  setError(e.message);
              } finally {
                  setCargando(false);
              }
          };

          return (
              <div className="tarjeta" style={{marginTop:20}}>
                  <h3><i className="fa-solid fa-user-plus"></i> Agregar Nuevo Paciente</h3>
                  <form onSubmit={handleSubmit}>
                      <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                          <div>
                              <label className="etiqueta">RUT</label>
                              <input className="campo" type="text" name="rut" value={formData.rut} onChange={handleChange} required/>
                          </div>
                          <div>
                              <label className="etiqueta">Nombres</label>
                              <input className="campo" type="text" name="nombres" value={formData.nombres} onChange={handleChange} required/>
                          </div>
                          <div>
                              <label className="etiqueta">Apellidos</label>
                              <input className="campo" type="text" name="apellidos" value={formData.apellidos} onChange={handleChange} required/>
                          </div>
                          <div>
                              <label className="etiqueta">Email</label>
                              <input className="campo" type="email" name="email" value={formData.email} onChange={handleChange} required/>
                          </div>
                          <div>
                              <label className="etiqueta">Teléfono</label>
                              <input className="campo" type="tel" name="telefono" value={formData.telefono} onChange={handleChange}/>
                          </div>
                          <div>
                              <label className="etiqueta">Contraseña (Por Defecto)</label>
                              <input className="campo" type="text" name="contrasena" value={formData.contrasena} onChange={handleChange} required/>
                              <span className="ayuda">Se recomienda cambiar en el primer inicio de sesión.</span>
                          </div>
                      </div>

                      <div style={{marginTop:20}}>
                          <button className="boton primario" type="submit" disabled={cargando}>
                              {cargando ? "Guardando..." : "Guardar Paciente"}
                          </button>
                      </div>

                      {exito && <p className="ok" style={{marginTop:10}}>{exito}</p>}
                      {error && <p className="err" style={{marginTop:10}}>Error: {error}</p>}
                  </form>
              </div>
          );
      }
    
    function CapaAdministrador(){
        const [conteos, setConteos] = useState({});
        const [usuarios, setUsuarios] = useState([]);
        const [cargandoDatos, setCargandoDatos] = useState(true);
        const [usuarioEditando, setUsuarioEditando] = useState(null); 

        const cargarDatos = async () => {
            setCargandoDatos(true);
            try {
                const token = localStorage.getItem("token");
                const res = await api("usuarios.php", { metodo: "GET", token });
                
                const totalUsuarios = res.usuarios.length;
                
                setConteos({
                    total: totalUsuarios,
                    paciente: res.conteos['paciente'] || 0,
                    doctor: res.conteos['doctor'] || 0,
                    admin: res.conteos['admin'] || 0
                });
                setUsuarios(res.usuarios);
            } catch (e) {
                console.error("Error al cargar datos del administrador:", e);

            } finally {
                setCargandoDatos(false);
            }
        };

        useEffect(() => {
            cargarDatos();
        }, []);

        const handleGuardarUsuario = () => {
            setUsuarioEditando(null); 
            cargarDatos(); 
        };


        return (
            <>
              
              <div className="tarjeta">
                  <h2>Bienvenido, Administrador</h2>
                  <p>Desde este panel podrás gestionar los usuarios, doctores y pacientes del sistema.</p>
              </div>

       
              <div className="tarjeta" style={{marginTop:20}}>
                  <h3>Resumen general {cargandoDatos && <i className="fa-solid fa-spinner fa-spin"></i>}</h3>
                  <ul>
                    <li><i className="fa-solid fa-users"></i> Usuarios Totales: <strong>{conteos.total || 0}</strong></li>
                    <li><i className="fa-solid fa-user"></i> Pacientes registrados: <strong>{conteos['paciente'] || 0}</strong></li>
                    <li><i className="fa-solid fa-user-doctor"></i> Doctores registrados: <strong>{conteos['doctor'] || 0}</strong></li>
                    <li><i className="fa-solid fa-shield-halved"></i> Administradores: <strong>{conteos['admin'] || 0}</strong></li>
                  </ul>
              </div>

              <TablaUsuarios 
                  usuarios={usuarios} 
                  onUsuarioEliminado={cargarDatos} 
                  onModificarUsuario={setUsuarioEditando} 
              />
              
       
              <FormularioAgregarPaciente onPacienteAgregado={cargarDatos} />

         
              {usuarioEditando && (
                <ModalEditarUsuario 
                    usuario={usuarioEditando} 
                    onClose={() => setUsuarioEditando(null)} 
                    onSave={handleGuardarUsuario} 
                />
              )}
            </>
        );
    }


    const raizAdmin = ReactDOM.createRoot(document.getElementById("aplicacion-admin"));
    raizAdmin.render(<CapaAdministrador/>);
  </script>
</body>
</html>